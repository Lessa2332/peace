<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR-–≥—Ä–∞ ¬´–ú—ñ—Å—ñ—è –ú–∏—Ä—É¬ª ‚Äî –≤–µ—Å–µ–ª–∞ —Ç–∞ –Ω–∞–≤—á–∞–ª—å–Ω–∞ –≥—Ä–∞ –¥–ª—è –¥—ñ—Ç–µ–π 7-9 —Ä–æ–∫—ñ–≤ –∑ –æ–∂–∏–≤–∞–Ω–Ω—è–º –≥–æ–ª—É–±–∞ –≤ AR">
    <title>üéâ AR –ì—Ä–∞ ¬´–ú—ñ—Å—ñ—è –ú–∏—Ä—É¬ª üéà</title>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <!-- Comic Neue –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            background: transparent; /* –ü—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω */
        }
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(135, 206, 235, 0.2); /* –ú–∞–π–∂–µ –ø—Ä–æ–∑–æ—Ä–∏–π –ª–æ–∞–¥–µ—Ä */
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #FF4500;
            font-size: 1.8em;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .ui-btn {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.2em;
            font-weight: bold;
            text-decoration: none;
            z-index: 1000;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            display: none;
            color: white;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, 0); }
            50% { transform: translate(-50%, -8px); }
        }
        #playBtn {
            bottom: 200px;
            background: linear-gradient(45deg, #FF69B4, #FF4500);
        }
        #stopBtn {
            bottom: 200px;
            background: linear-gradient(45deg, #FF0000, #FF69B4);
        }
        #resetBtn {
            bottom: 120px;
            background: linear-gradient(45deg, #00BFFF, #1E90FF);
        }
        #nextBtn {
            bottom: 180px;
            background: linear-gradient(45deg, #54a0ff, #5f27cd);
        }
        #endBtn {
            bottom: 260px;
            background: linear-gradient(45deg, #FF4500, #FF0000);
        }
        #soundBtn {
            bottom: 280px;
            background: linear-gradient(45deg, #32CD32, #228B22);
        }
        #youtubeBtn {
            bottom: 40px;
            left: 40px;
            transform: none;
            padding: 12px 20px;
            background: linear-gradient(45deg, #FF4500, #FF69B4);
            border-radius: 30px;
            font-size: 1em;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            z-index: 1100;
        }
        #youtubeBtn:hover {
            box-shadow: 0 7px 18px rgba(0, 0, 0, 0.4);
        }
        .ui-info-text {
            position: fixed;
            left: 20px;
            top: 20px;
            z-index: 500;
            text-align: left;
            font-weight: bold;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
            color: #FFD700;
            font-size: 1.4em;
        }
        #timerText {
            color: #00008B;
            font-size: 1.4em;
            display: none;
        }
        #scoreText {
            top: 50px;
            color: #00FF7F;
            font-size: 1.4em;
            display: none;
        }
        #canvasGameContainer {
            z-index: 1000;
            position: relative;
            background: transparent;
        }
        #endMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 165, 0, 0.9);
            color: white;
            padding: 25px;
            border-radius: 20px;
            z-index: 10000;
            font-size: 1.3em;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            display: none;
            animation: popIn 0.5s ease;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="arjs-loader" id="loader">
        <div class="pulse">üéâ –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –≥—Ä–∏ ¬´–ú—ñ—Å—ñ—è –ú–∏—Ä—É¬ª üéà</div>
        <div style="margin-top: 20px; font-size: 1.2em;">
            –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —Ä–æ–∑–º–∞–ª—å–æ–≤–∫—É –≥–æ–ª—É–±–∞! üòäüé®
        </div>
    </div>

    <p id="timerText" class="ui-info-text">‚è≥ –ß–∞—Å: 01:00</p>
    <p id="scoreText" class="ui-info-text">üåü –û—á–∫–∏: 0</p>

    <div id="canvasGameContainer" style="display: none;">
        <canvas id="gameCanvas"></canvas>
        <button id="endBtn" class="ui-btn" aria-label="–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –≥—Ä—É">üõë –ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
    </div>

    <div id="endMessage"></div>

    <a-scene
        mindar-image="imageTargetSrc: ./targets.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets timeout="30000">
            <audio id="bg-music" src="./bg-music.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="click-sound" src="./click-sound.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <audio id="logo-sound" src="./lab.mp3" preload="auto" muted playsinline crossorigin="anonymous"></audio>
            <video id="dove-video" src="./dove_flying.mp4" preload="auto" loop="true" playsinline crossorigin="anonymous" muted="true"></video>
        </a-assets>

        <a-camera
            look-controls="enabled: false"
            position="0 0 0"
        >
            <a-cursor
                raycaster="objects: .emoji;"
                cursor="fuse: false; maxDistance: 10"
                position="0 0 -1"
                geometry="primitive: ring; radiusOuter: 0.015; radiusInner: 0.008"
                material="color: #FFD700; shader: flat"
            ></a-cursor>
        </a-camera>

        <a-entity id="game-elements" visible="false">
            <!-- AR-–µ–ª–µ–º–µ–Ω—Ç–∏ –≥—Ä–∏ -->
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-video
                id="dove-video-entity"
                src="#dove-video"
                position="0 0 0.1"
                width="1"
                height="1"
                rotation="0 0 0"
                visible="true"
            ></a-video>
        </a-entity>
    </a-scene>

    <button id="playBtn" class="ui-btn" aria-label="–ü–æ—á–∞—Ç–∏ –≥—Ä—É">üöÄ –ü–æ—á–∞—Ç–∏ –≥—Ä—É!</button>
    <button id="stopBtn" class="ui-btn" style="display: none;" aria-label="–ó—É–ø–∏–Ω–∏—Ç–∏ –≥—Ä—É">üõë –ó—É–ø–∏–Ω–∏—Ç–∏</button>
    <button id="resetBtn" class="ui-btn" style="display: none;" aria-label="–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ">üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ!</button>
    <button id="soundBtn" class="ui-btn" style="display: none;" aria-label="–£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫">üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
    <a href="https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi" id="youtubeBtn" target="_blank" aria-label="–í—ñ–¥–≤—ñ–¥–∞—Ç–∏ YouTube-–∫–∞–Ω–∞–ª SmartLessa">‚ù§Ô∏è –ê–≤—Ç–æ—Ä SmartLessa</a>

    <script>
        // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±–µ—Ä—Ç–∞–Ω–Ω—è (–∑–∞–ª–∏—à–µ–Ω–æ –¥–ª—è –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è)
        AFRAME.registerComponent('rotate-by-touch', {
            init: function () {
                this.isDragging = false;
                this.lastX = 0;
                this.el.object3D.rotation.y = 0;

                this.onTouchStart = this.onTouchStart.bind(this);
                this.onTouchMove = this.onTouchMove.bind(this);
                this.onTouchEnd = this.onTouchEnd.bind(this);

                if (!this.el.hasAttribute('data-touch-listeners')) {
                    window.addEventListener('touchstart', this.onTouchStart, { passive: false });
                    window.addEventListener('touchmove', this.onTouchMove, { passive: false });
                    window.addEventListener('touchend', this.onTouchEnd);
                    this.el.setAttribute('data-touch-listeners', 'true');
                }
            },

            onTouchStart: function (e) {
                if (e.touches.length === 1) {
                    this.isDragging = true;
                    this.lastX = e.touches[0].clientX;
                }
            },

            onTouchMove: function (e) {
                if (!this.isDragging) return;
                e.preventDefault();
                const deltaX = e.touches[0].clientX - this.lastX;
                this.lastX = e.touches[0].clientX;
                this.el.object3D.rotation.y += deltaX * 0.01;
            },

            onTouchEnd: function () {
                this.isDragging = false;
            },

            remove: function () {
                window.removeEventListener('touchstart', this.onTouchStart);
                window.removeEventListener('touchmove', this.onTouchMove);
                window.removeEventListener('touchend', this.onTouchEnd);
                this.el.removeAttribute('data-touch-listeners');
            }
        });

        // –§—ñ–∫—Å–∞—Ü—ñ—è –≤–∏—Å–æ—Ç–∏ –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤
        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        // –ó–º—ñ–Ω–Ω—ñ —Ç–∞ –µ–ª–µ–º–µ–Ω—Ç–∏ DOM
        const loader = document.querySelector('#loader');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const doveVideoEntity = document.querySelector('#dove-video-entity');
        const doveVideo = document.querySelector('#dove-video');
        const playBtn = document.querySelector('#playBtn');
        const stopBtn = document.querySelector('#stopBtn');
        const resetBtn = document.querySelector('#resetBtn');
        const soundBtn = document.querySelector('#soundBtn');
        const youtubeBtn = document.querySelector('#youtubeBtn');
        const gameElements = document.querySelector('#game-elements');
        const timerText = document.getElementById('timerText');
        const scoreText = document.getElementById('scoreText');
        const bgMusic = document.querySelector('#bg-music');
        const logoSound = document.querySelector('#logo-sound');
        const clickSound = document.querySelector('#click-sound');
        const endMessage = document.getElementById('endMessage');

        let isGameRunning = false;
        let arStarted = false;
        let score = 0;

        // –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–µ–æ
        doveVideo.addEventListener('loadeddata', () => {
            console.log("‚úÖ –í—ñ–¥–µ–æ dove_flying.mp4 —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ");
        });
        doveVideo.addEventListener('error', () => {
            console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è dove_flying.mp4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —à–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –∞–±–æ —Ñ–æ—Ä–º–∞—Ç.");
        });

        // –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö –∞—É–¥—ñ–æ
        function stopAllAudio() {
            [bgMusic, logoSound, clickSound].forEach(audio => {
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    audio.muted = true;
                }
            });
            if (doveVideo) doveVideo.pause();
        }

        // –û–±—Ä–æ–±–∫–∞ –≤—Ç—Ä–∞—Ç–∏ —Ñ–æ–∫—É—Å—É —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                console.log("‚ÑπÔ∏è –°—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—Ç—Ä–∞—Ç–∏–ª–∞ —Ñ–æ–∫—É—Å, –∑—É–ø–∏–Ω—è—î–º–æ –∑–≤—É–∫–∏");
                stopAllAudio();
            }
        });

        // –ö–Ω–æ–ø–∫–∞ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –∑–≤—É–∫—É
        soundBtn.addEventListener('click', () => {
            const isMuted = bgMusic ? bgMusic.muted : true;
            [bgMusic, logoSound, clickSound, doveVideo].forEach(media => {
                if (media) media.muted = !isMuted;
            });
            soundBtn.textContent = isMuted ? 'üîá –í–∏–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫' : 'üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫';
            if (!isMuted && bgMusic) {
                bgMusic.play().catch(e => console.log("üîá –ú—É–∑–∏–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—è:", e));
            }
            if (!isMuted && doveVideo) {
                doveVideo.play().catch(e => console.log("üîá –í—ñ–¥–µ–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—è:", e));
            }
            soundBtn.style.display = 'none';
        });

        // –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ–π AR
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ! –ì–æ–ª—É–± –æ–∂–∏–≤–∞—î.");
                arStarted = true;
                loader.style.display = 'none';
                playBtn.style.display = 'block';
                soundBtn.style.display = 'block';
                youtubeBtn.style.display = 'block';
                if (doveVideoEntity) doveVideoEntity.setAttribute('visible', 'true');
                if (doveVideo) {
                    doveVideo.play().catch(e => console.log("üîá –í—ñ–¥–µ–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—è:", e));
                }
            });

            targetEntity.addEventListener('targetLost', () => {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ, –∞–ª–µ –≥—Ä–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è.");
            });
        }

        // YouTube-–∫–Ω–æ–ø–∫–∞
        youtubeBtn.addEventListener('click', () => {
            console.log("üîó –ö–ª—ñ–∫ –ø–æ YouTube-–∫–Ω–æ–ø—Ü—ñ!");
            window.open('https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi', '_blank');
        });
        youtubeBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            console.log("üîó –°–µ–Ω—Å–æ—Ä–Ω–∏–π –∫–ª—ñ–∫ –ø–æ YouTube-–∫–Ω–æ–ø—Ü—ñ!");
            window.open('https://www.youtube.com/@23smartlessa32?si=d3NhKDot8U8Mc2Hi', '_blank');
        });

        // ============ STATE MANAGEMENT ============
        const GAME_STATES = {
            MENU: 'menu',
            LEVEL_1: 'level1',
            LEVEL_2: 'level2',
            LEVEL_3: 'level3',
            LEVEL_4: 'level4',
            LEVEL_5: 'level5',
            TIP: 'tip',
            END: 'end'
        };

        // ============ SYSTEMS ============
        class InputSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.touches = [];
                this.clicks = [];
                this.setupListeners();
            }

            setupListeners() {
                this.canvas.addEventListener('click', (e) => this.handleClick(e));
                this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e), { passive: false });
            }

            handleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                this.clicks.push({ x: e.clientX - rect.left, y: e.clientY - rect.top });
            }

            handleTouch(e) {
                e.preventDefault();
                const rect = this.canvas.getBoundingClientRect();
                for (let touch of e.touches) {
                    this.touches.push({ x: touch.clientX - rect.left, y: touch.clientY - rect.top });
                }
            }

            getInputs() {
                const allInputs = [...this.clicks, ...this.touches];
                this.clicks = [];
                this.touches = [];
                return allInputs;
            }

            clear() {
                this.clicks = [];
                this.touches = [];
            }
        }

        class RenderSystem {
            constructor(ctx, canvas) {
                this.ctx = ctx;
                this.canvas = canvas;
                this.ctx.font = "18px 'Comic Neue', 'Comic Sans MS', cursive, sans-serif";
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
            }

            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            drawText(text, x, y, size = '20px', color = '#FFFFFF', align = 'center') {
                this.ctx.font = `${size} 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                this.ctx.textAlign = align;
                this.ctx.fillStyle = color;
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                this.ctx.shadowBlur = 4;
                this.ctx.fillText(text, x, y);
                this.ctx.shadowBlur = 0;
            }

            drawWrappedText(text, x, y, size = '16px', color = '#FFFFFF', maxWidth = 250) {
                this.ctx.font = `${size} 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                this.ctx.textAlign = 'center';
                this.ctx.fillStyle = color;
                this.ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                this.ctx.shadowBlur = 4;

                const words = text.split(' ');
                let line = '';
                let lines = [];
                const lineHeight = parseInt(size) * 1.2;

                for (let word of words) {
                    const testLine = line + word + ' ';
                    const metrics = this.ctx.measureText(testLine);
                    if (metrics.width > maxWidth && line !== '') {
                        lines.push(line);
                        line = word + ' ';
                    } else {
                        line = testLine;
                    }
                }
                lines.push(line);

                lines.forEach((line, i) => {
                    this.ctx.fillText(line, x, y + i * lineHeight);
                });
                this.ctx.shadowBlur = 0;
            }

            drawEmoji(emoji, x, y, size, alpha = 1) {
                this.ctx.globalAlpha = alpha;
                this.ctx.font = `${size}px 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                this.ctx.fillStyle = '#FFD700';
                this.ctx.strokeStyle = '#000000';
                this.ctx.lineWidth = 2;
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.strokeText(emoji, x, y);
                this.ctx.fillText(emoji, x, y);
                this.ctx.globalAlpha = 1;
            }

            drawExplosion(x, y, time) {
                this.ctx.fillStyle = '#FF4500';
                for (let i = 0; i < 10; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const dist = Math.random() * 20 * time;
                    this.ctx.fillText('‚ú®', x + Math.cos(angle) * dist, y + Math.sin(angle) * dist);
                }
            }
        }

        class CollisionSystem {
            static isPointInCircle(px, py, cx, cy, radius) {
                const dx = px - cx;
                const dy = py - cy;
                return dx * dx + dy * dy <= radius * radius;
            }
        }

        class GameState {
            constructor(game) {
                this.game = game;
            }
            enter() {}
            exit() {}
            update(deltaTime) {}
            render() {}
            handleInput(inputs) {}
        }

        class MenuState extends GameState {
            enter() {
                this.game.resetUI();
                this.game.showUI(['playBtn', 'soundBtn', 'youtubeBtn']);
            }

            render() {
                this.game.renderSystem.drawText("‚ú® –ú—ñ—Å—ñ—è –ú–∏—Ä—É ‚ú®", this.game.canvas.width / 2, this.game.canvas.height / 2 - 80, '36px', '#FF69B4');
                this.game.renderSystem.drawText("–¢–∏—Å–Ω–∏ –Ω–∞ –∑—ñ—Ä–æ—á–∫–∏ ‚Äî –≤—Ä—è—Ç—É–π —Å–≤—ñ—Ç! üåü", this.game.canvas.width / 2, this.game.canvas.height / 2 - 30, '20px', '#FFD700');
                this.game.renderSystem.drawText("–ù–∞—Ç–∏—Å–Ω–∏ üöÄ –ü–æ—á–∞—Ç–∏!", this.game.canvas.width / 2, this.game.canvas.height / 2 + 30, '24px', '#32CD32');
            }

            handleInput(inputs) {
                if (inputs.length > 0) {
                    this.game.setState(GAME_STATES.LEVEL_1);
                }
            }
        }

        class Level1State extends GameState {
            constructor(game) {
                super(game);
                this.lights = [];
                this.maxLights = 8;
                this.collected = 0;
                this.bgDarkness = 0.8;
                this.explosions = [];
            }

            enter() {
                this.lights = [];
                this.collected = 0;
                this.bgDarkness = 0.8;
                this.explosions = [];
                this.spawnLights();
                this.game.resetUI();
                this.game.showUI(['endBtn']);
            }

            spawnLights() {
                for (let i = 0; i < this.maxLights; i++) {
                    this.lights.push({
                        x: Math.random() * this.game.canvas.width,
                        y: Math.random() * this.game.canvas.height,
                        size: 35 + Math.random() * 15,
                        vx: (Math.random() - 0.5) * 3,
                        vy: (Math.random() - 0.5) * 3,
                        emoji: ['‚ú®', 'üí´', '‚≠ê'][Math.floor(Math.random() * 3)],
                        pulse: Math.random() * 2 * Math.PI
                    });
                }
            }

            update(deltaTime) {
                this.lights.forEach(light => {
                    light.x += light.vx;
                    light.y += light.vy;
                    if (light.x < 0 || light.x > this.game.canvas.width) light.vx *= -1;
                    if (light.y < 0 || light.y > this.game.canvas.height) light.vy *= -1;
                    light.pulse += deltaTime * 2;
                });

                if (this.collected > 0) {
                    this.bgDarkness = Math.max(0.2, this.bgDarkness - 0.002);
                }

                this.explosions = this.explosions.filter(exp => {
                    exp.time += deltaTime;
                    return exp.time < 1;
                });

                if (this.collected >= this.maxLights) {
                    setTimeout(() => {
                        this.game.tipText = "–ú–∏—Ä –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ —Ç–µ–±–µ! –ù–∞–ø–∏—à–∏ 3 –¥–æ–±—Ä—ñ –≤—á–∏–Ω–∫–∏, —è–∫—ñ –º–æ–∂–µ—à –∑—Ä–æ–±–∏—Ç–∏ —Å—å–æ–≥–æ–¥–Ω—ñ. üòä";
                        this.game.setState(GAME_STATES.TIP);
                    }, 1500);
                }
            }

            render() {
                this.game.ctx.fillStyle = `rgba(0, 0, 0, ${this.bgDarkness})`;
                this.game.ctx.fillRect(0, 0, this.game.canvas.width, this.game.canvas.height);

                this.lights.forEach(light => {
                    const scale = 1 + Math.sin(light.pulse) * 0.2;
                    const size = light.size * scale;
                    this.game.ctx.fillStyle = '#FFD700';
                    this.game.ctx.strokeStyle = '#FF4500';
                    this.game.ctx.lineWidth = 2;
                    this.game.ctx.font = `${size}px 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                    this.game.ctx.textAlign = 'center';
                    this.game.ctx.textBaseline = 'middle';
                    this.game.ctx.strokeText(light.emoji, light.x, light.y);
                    this.game.ctx.fillText(light.emoji, light.x, light.y);
                });

                this.explosions.forEach(exp => {
                    this.game.renderSystem.drawExplosion(exp.x, exp.y, exp.time);
                });

                this.game.renderSystem.drawText(`–ó—ñ–±—Ä–∞–Ω–æ: ${this.collected}/${this.maxLights}`, this.game.canvas.width / 2, 30, '20px', '#32CD32');
                this.game.renderSystem.drawText("–¢–∏—Å–Ω–∏ –Ω–∞ –∑—ñ—Ä–æ—á–∫–∏! üåü", this.game.canvas.width / 2, this.game.canvas.height - 30, '18px', '#FF69B4');
            }

            handleInput(inputs) {
                inputs.forEach(input => {
                    for (let i = 0; i < this.lights.length; i++) {
                        const light = this.lights[i];
                        if (CollisionSystem.isPointInCircle(input.x, input.y, light.x, light.y, light.size / 2)) {
                            this.explosions.push({ x: light.x, y: light.y, time: 0 });
                            this.lights.splice(i, 1);
                            this.collected++;
                            score += 10;
                            scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
                            if (clickSound && !clickSound.muted) {
                                clickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                            }
                            break;
                        }
                    }
                });
            }
        }

        class Level2State extends GameState {
            constructor(game) {
                super(game);
                this.required = ['–ú', '–ò', '–†'];
                this.current = [];
                this.letters = [];
                this.spawned = 0;
            }

            enter() {
                this.current = [];
                this.letters = [];
                this.spawned = 0;
                this.spawnLetters();
                this.game.resetUI();
                this.game.showUI(['endBtn']);
            }

            spawnLetters() {
                if (this.spawned >= 15) return;
                const letter = this.required[Math.floor(Math.random() * this.required.length)];
                const baseSize = Math.min(this.game.canvas.width, this.game.canvas.height) * 0.08;
                this.letters.push({
                    x: Math.random() * this.game.canvas.width,
                    y: Math.random() * this.game.canvas.height,
                    size: baseSize,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    emoji: letter,
                    color: ['#FF4500', '#32CD32', '#00BFFF'][Math.floor(Math.random() * 3)]
                });
                this.spawned++;
                setTimeout(() => this.spawnLetters(), 600);
            }

            update(deltaTime) {
                this.letters.forEach(letter => {
                    letter.x += letter.vx;
                    letter.y += letter.vy;
                    if (letter.x < 0 || letter.x > this.game.canvas.width) letter.vx *= -1;
                    if (letter.y < 0 || letter.y > this.game.canvas.height) letter.vy *= -1;
                });

                if (this.current.length === 3 && this.current.every((l, i) => l === this.required[i])) {
                    setTimeout(() => {
                        this.game.tipText = "–ü—Ä–∏–¥—É–º–∞–π —Å–≤—ñ–π –¥–µ–≤—ñ–∑ –º–∏—Ä—É! ‚úçÔ∏è";
                        this.game.setState(GAME_STATES.TIP);
                    }, 1000);
                }
            }

            render() {
                this.letters.forEach(letter => {
                    this.game.ctx.strokeStyle = 'black';
                    this.game.ctx.lineWidth = 3;
                    this.game.ctx.font = `bold ${letter.size}px 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                    this.game.ctx.textAlign = 'center';
                    this.game.ctx.textBaseline = 'middle';
                    this.game.ctx.strokeText(letter.emoji, letter.x, letter.y);
                    this.game.ctx.fillStyle = letter.color;
                    this.game.ctx.fillText(letter.emoji, letter.x, letter.y);
                });

                this.game.ctx.strokeStyle = 'black';
                this.game.ctx.lineWidth = 3;
                this.game.ctx.font = `bold 24px 'Comic Neue', 'Comic Sans MS', cursive, sans-serif`;
                this.game.ctx.textAlign = 'center';
                this.game.ctx.strokeText(`–ó—ñ–±—Ä–∞–Ω–æ: ${this.current.join('')}`, this.game.canvas.width / 2, 30);
                this.game.ctx.fillStyle = '#FFD700';
                this.game.ctx.fillText(`–ó—ñ–±—Ä–∞–Ω–æ: ${this.current.join('')}`, this.game.canvas.width / 2, 30);
                this.game.renderSystem.drawText("–°–∫–ª–∞–¥–∏ —Å–ª–æ–≤–æ –ú–ò–†! üåç", this.game.canvas.width / 2, this.game.canvas.height - 30, '18px', '#FF69B4');
            }

            handleInput(inputs) {
                inputs.forEach(input => {
                    for (let i = 0; i < this.letters.length; i++) {
                        const letter = this.letters[i];
                        if (CollisionSystem.isPointInCircle(input.x, input.y, letter.x, letter.y, letter.size / 2)) {
                            if (this.current.length < 3 && letter.emoji === this.required[this.current.length]) {
                                this.current.push(letter.emoji);
                                score += 20;
                                scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
                            }
                            this.letters.splice(i, 1);
                            if (clickSound && !clickSound.muted) {
                                clickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                            }
                            break;
                        }
                    }
                });
            }
        }

        class Level3State extends GameState {
            constructor(game) {
                super(game);
                this.friends = [];
                this.clouds = [];
                this.hits = 0;
                this.requiredHits = 10;
            }

            enter() {
                this.hits = 0;
                this.friends = [
                    { x: this.game.canvas.width * 0.25, y: this.game.canvas.height * 0.7, emoji: 'üëß' },
                    { x: this.game.canvas.width * 0.5, y: this.game.canvas.height * 0.7, emoji: 'üßí' },
                    { x: this.game.canvas.width * 0.75, y: this.game.canvas.height * 0.7, emoji: 'üë¶' }
                ];
                this.spawnClouds();
                this.game.resetUI();
                this.game.showUI(['endBtn']);
            }

            spawnClouds() {
                if (this.hits >= this.requiredHits) return;
                const cloud = {
                    x: Math.random() * this.game.canvas.width,
                    y: -50,
                    size: 50,
                    vy: 1 + Math.random() * 2,
                    emoji: '‚òÅÔ∏è‚ö´'
                };
                this.clouds.push(cloud);
                setTimeout(() => this.spawnClouds(), 1200);
            }

            update(deltaTime) {
                this.clouds = this.clouds.filter(cloud => {
                    cloud.y += cloud.vy;
                    return cloud.y < this.game.canvas.height + 50;
                });

                if (this.hits >= this.requiredHits) {
                    setTimeout(() => {
                        this.game.tipText = "–°–∏–ª–∞ –º–∏—Ä—É –≤ —î–¥–Ω–æ—Å—Ç—ñ. –ù–∞–º–∞–ª—é–π –∫–æ–ª–æ –¥—Ä—É–∑—ñ–≤ —ñ –≤–ø–∏—à–∏ —Ç—É–¥–∏ —Ç–∏—Ö, —ñ–∑ –∫–∏–º —Ç–æ–±—ñ –¥–æ–±—Ä–µ.";
                        this.game.setState(GAME_STATES.TIP);
                    }, 1000);
                }
            }

            render() {
                this.friends.forEach(friend => {
                    this.game.renderSystem.drawEmoji(friend.emoji, friend.x, friend.y, 50);
                });

                this.clouds.forEach(cloud => {
                    this.game.renderSystem.drawEmoji(cloud.emoji, cloud.x, cloud.y, cloud.size);
                });

                this.game.renderSystem.drawText(`–í—ñ–¥–±–∏—Ç–æ: ${this.hits}/${this.requiredHits}`, this.game.canvas.width / 2, 30, '20px', '#32CD32');
                this.game.renderSystem.drawText("–†–æ–∑–∂–µ–Ω–∏ —Ö–º–∞—Ä–∏! ‚òÅÔ∏è", this.game.canvas.width / 2, this.game.canvas.height - 30, '18px', '#FF69B4');
            }

            handleInput(inputs) {
                inputs.forEach(input => {
                    for (let i = 0; i < this.clouds.length; i++) {
                        const cloud = this.clouds[i];
                        if (CollisionSystem.isPointInCircle(input.x, input.y, cloud.x, cloud.y, cloud.size / 2)) {
                            this.clouds.splice(i, 1);
                            this.hits++;
                            score += 15;
                            scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
                            if (clickSound && !clickSound.muted) {
                                clickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                            }
                            break;
                        }
                    }
                });
            }
        }

        class Level4State extends GameState {
            constructor(game) {
                super(game);
                this.tree = { x: this.game.canvas.width / 2, y: this.game.canvas.height * 0.7, emoji: 'üå≥' };
                this.leaves = [];
                this.attachedLeaves = [];
                this.requiredLeaves = 10;
            }

            enter() {
                this.attachedLeaves = [];
                this.leaves = [];
                this.spawnLeaves();
                this.game.resetUI();
                this.game.showUI(['endBtn']);
            }

            spawnLeaves() {
                if (this.attachedLeaves.length >= this.requiredLeaves) return;
                const leaf = {
                    x: Math.random() * this.game.canvas.width,
                    y: -50,
                    size: 30,
                    vy: 1 + Math.random() * 2,
                    emoji: ['üçÉ', 'üçÇ'][Math.floor(Math.random() * 2)]
                };
                this.leaves.push(leaf);
                setTimeout(() => this.spawnLeaves(), 1000);
            }

            update(deltaTime) {
                this.leaves = this.leaves.filter(leaf => {
                    leaf.y += leaf.vy;
                    return leaf.y < this.game.canvas.height + 50;
                });

                if (this.attachedLeaves.length >= this.requiredLeaves) {
                    setTimeout(() => {
                        this.game.tipText = "–ú–∏—Ä ‚Äî —Ü–µ –≥–∞—Ä–º–æ–Ω—ñ—è –ø—Ä–∏—Ä–æ–¥–∏. –ù–∞–º–∞–ª—é–π —Å–≤–æ—î ¬´–î–µ—Ä–µ–≤–æ –º–∏—Ä—É¬ª —ñ –ø—ñ–¥–ø–∏—à–∏ –π–æ–≥–æ –≥—ñ–ª–∫–∏ (–¥–æ–±—Ä–æ—Ç–∞, –¥—Ä—É–∂–±–∞, –¥–æ–ø–æ–º–æ–≥–∞‚Ä¶)";
                        this.game.setState(GAME_STATES.TIP);
                    }, 1000);
                }
            }

            render() {
                this.game.renderSystem.drawEmoji(this.tree.emoji, this.tree.x, this.tree.y, 70);

                this.leaves.forEach(leaf => {
                    this.game.renderSystem.drawEmoji(leaf.emoji, leaf.x, leaf.y, leaf.size);
                });

                this.attachedLeaves.forEach((leaf, i) => {
                    const angle = (i / this.attachedLeaves.length) * Math.PI * 2;
                    const radius = 50;
                    const x = this.tree.x + Math.cos(angle) * radius;
                    const y = this.tree.y + Math.sin(angle) * radius - 20;
                    this.game.renderSystem.drawEmoji(leaf.emoji, x, y, leaf.size);
                });

                this.game.renderSystem.drawText(`–õ–∏—Å—Ç–æ—á–∫—ñ–≤: ${this.attachedLeaves.length}/${this.requiredLeaves}`, this.game.canvas.width / 2, 30, '20px', '#32CD32');
                this.game.renderSystem.drawText("–ó–±–µ—Ä–∏ –ª–∏—Å—Ç–æ—á–∫–∏ –Ω–∞ –¥–µ—Ä–µ–≤–æ! üå≥", this.game.canvas.width / 2, this.game.canvas.height - 30, '18px', '#FF69B4');
            }

            handleInput(inputs) {
                inputs.forEach(input => {
                    for (let i = 0; i < this.leaves.length; i++) {
                        const leaf = this.leaves[i];
                        if (CollisionSystem.isPointInCircle(input.x, input.y, leaf.x, leaf.y, leaf.size / 2)) {
                            this.attachedLeaves.push({...leaf});
                            this.leaves.splice(i, 1);
                            score += 10;
                            scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
                            if (clickSound && !clickSound.muted) {
                                clickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                            }
                            break;
                        }
                    }
                });
            }
        }

        class Level5State extends GameState {
            constructor(game) {
                super(game);
                this.heart = { x: this.game.canvas.width / 2, y: this.game.canvas.height / 2, size: 50, pulse: 0 };
                this.brightness = 0.3;
            }

            enter() {
                this.game.resetUI();
                this.game.showUI(['endBtn']);
            }

            update(deltaTime) {
                this.heart.pulse += deltaTime * 5;
                this.heart.size = 50 + Math.sin(this.heart.pulse) * 8;

                if (this.brightness < 1) {
                    this.brightness += 0.005;
                }
            }

            render() {
                const heartEmoji = this.brightness > 0.7 ? 'üíôüíõ' : '‚ù§Ô∏è';
                this.game.renderSystem.drawEmoji(heartEmoji, this.heart.x, this.heart.y, this.heart.size);

                this.game.renderSystem.drawText("–¢–æ—Ä–∫–Ω–∏—Å—å —Å–µ—Ä—Ü—è, —â–æ–± –≤–æ–Ω–æ –∑–∞—Å—è—è–ª–æ!", this.game.canvas.width / 2, this.game.canvas.height - 30, '18px', '#FF69B4');
            }

            handleInput(inputs) {
                inputs.forEach(input => {
                    if (CollisionSystem.isPointInCircle(input.x, input.y, this.heart.x, this.heart.y, this.heart.size / 2)) {
                        this.brightness = Math.min(1, this.brightness + 0.2);
                        score += 50;
                        scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
                        if (clickSound && !clickSound.muted) {
                            clickSound.play().catch(e => console.log("üîá –ó–≤—É–∫ –∫–ª—ñ–∫—É –Ω–µ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è:", e));
                        }
                    }
                });

                if (this.brightness >= 1) {
                    setTimeout(() => {
                        this.game.tipText = "–ú–∏—Ä —É —Å–≤—ñ—Ç—ñ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ –º–∏—Ä—É –≤ —Å–µ—Ä—Ü—ñ. –ù–∞–º–∞–ª—é–π —Å–≤—ñ–π —Å–∏–º–≤–æ–ª –º–∏—Ä—É.";
                        this.game.setState(GAME_STATES.TIP);
                    }, 1000);
                }
            }
        }

        class TipState extends GameState {
            enter() {
                this.game.resetUI();
                this.game.showUI(['nextBtn', 'endBtn']);
            }

            render() {
                this.game.renderSystem.drawText("üí° –¢–≤–æ—Ä—á–µ –∑–∞–≤–¥–∞–Ω–Ω—è:", this.game.canvas.width / 2, this.game.canvas.height / 2 - 60, '24px', '#FFD700');
                this.game.renderSystem.drawWrappedText(this.game.tipText, this.game.canvas.width / 2, this.game.canvas.height / 2, '16px', '#FFFFFF', 250);
                this.game.renderSystem.drawText("–ù–∞—Ç–∏—Å–Ω–∏ ‚ñ∂Ô∏è –î–∞–ª—ñ", this.game.canvas.width / 2, this.game.canvas.height / 2 + 60, '20px', '#00FF7F');
            }

            handleInput(inputs) {
                if (inputs.length > 0) {
                    const levelMap = {
                        [GAME_STATES.LEVEL_1]: GAME_STATES.LEVEL_2,
                        [GAME_STATES.LEVEL_2]: GAME_STATES.LEVEL_3,
                        [GAME_STATES.LEVEL_3]: GAME_STATES.LEVEL_4,
                        [GAME_STATES.LEVEL_4]: GAME_STATES.LEVEL_5,
                        [GAME_STATES.LEVEL_5]: GAME_STATES.END
                    };
                    const nextState = levelMap[this.game.previousState] || GAME_STATES.END;
                    console.log(`–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Å—Ç–∞–Ω—É: ${nextState}`);
                    this.game.setState(nextState);
                }
            }
        }

        class EndState extends GameState {
            enter() {
                this.game.resetUI();
                this.game.showUI(['resetBtn', 'endBtn']);
                endMessage.style.display = 'block';
                endMessage.innerHTML = `üéâ –ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!<br>–¢–∏ –Ω–∞–±—Ä–∞–≤ ${score} –æ—á–æ–∫!`;
            }

            exit() {
                endMessage.style.display = 'none';
            }

            render() {
                this.game.renderSystem.drawText("üéâ –ì—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ!", this.game.canvas.width / 2, this.game.canvas.height / 2 - 30, '28px', '#00FF7F');
                this.game.renderSystem.drawText(`–¢–∏ –Ω–∞–±—Ä–∞–≤ ${score} –æ—á–æ–∫!`, this.game.canvas.width / 2, this.game.canvas.height / 2 + 20, '20px', '#FFFFFF');
            }
        }

        class Game {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.updateCanvasSize();
                window.addEventListener('resize', () => this.updateCanvasSize());

                this.inputSystem = new InputSystem(this.canvas);
                this.renderSystem = new RenderSystem(this.ctx, this.canvas);
                this.stateMap = {
                    [GAME_STATES.MENU]: new MenuState(this),
                    [GAME_STATES.LEVEL_1]: new Level1State(this),
                    [GAME_STATES.LEVEL_2]: new Level2State(this),
                    [GAME_STATES.LEVEL_3]: new Level3State(this),
                    [GAME_STATES.LEVEL_4]: new Level4State(this),
                    [GAME_STATES.LEVEL_5]: new Level5State(this),
                    [GAME_STATES.TIP]: new TipState(this),
                    [GAME_STATES.END]: new EndState(this)
                };

                this.currentState = null;
                this.previousState = null;
                this.tipText = "";
                this.lastTime = 0;
                this.debug = true;

                this.nextBtn = document.createElement('button');
                this.nextBtn.id = 'nextBtn';
                this.nextBtn.className = 'ui-btn';
                this.nextBtn.textContent = '‚è≠ –î–∞–ª—ñ';
                this.nextBtn.style.bottom = '180px';
                this.nextBtn.style.background = 'linear-gradient(45deg, #54a0ff, #5f27cd)';
                this.nextBtn.setAttribute('aria-label', '–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è');
                this.nextBtn.addEventListener('click', () => {
                    const levelMap = {
                        [GAME_STATES.LEVEL_1]: GAME_STATES.LEVEL_2,
                        [GAME_STATES.LEVEL_2]: GAME_STATES.LEVEL_3,
                        [GAME_STATES.LEVEL_3]: GAME_STATES.LEVEL_4,
                        [GAME_STATES.LEVEL_4]: GAME_STATES.LEVEL_5,
                        [GAME_STATES.LEVEL_5]: GAME_STATES.END
                    };
                    const nextState = levelMap[this.previousState] || GAME_STATES.END;
                    console.log(`–ö–Ω–æ–ø–∫–∞ –î–∞–ª—ñ: –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ ${nextState}`);
                    this.setState(nextState);
                });
                document.body.appendChild(this.nextBtn);

                this.resetUI();
                this.setState(GAME_STATES.MENU);
                this.gameLoop(0);
            }

            updateCanvasSize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }

            resetUI() {
                this.hideUI(['playBtn', 'stopBtn', 'resetBtn', 'nextBtn', 'endBtn', 'soundBtn', 'youtubeBtn']);
                scoreText.style.display = 'none';
                timerText.style.display = 'none';
            }

            showUI(ids) {
                ids.forEach(id => {
                    const el = document.getElementById(id) || (id === 'nextBtn' ? this.nextBtn : null);
                    if (el) el.style.display = 'block';
                });
                if (ids.includes('playBtn') || ids.includes('endBtn')) {
                    scoreText.style.display = 'block';
                }
            }

            hideUI(ids) {
                ids.forEach(id => {
                    const el = document.getElementById(id) || (id === 'nextBtn' ? this.nextBtn : null);
                    if (el) el.style.display = 'none';
                });
            }

            setState(state) {
                if (this.currentState) {
                    this.currentState.exit();
                }
                this.previousState = Object.values(GAME_STATES).find(key => this.stateMap[key] === this.currentState) || this.previousState;
                this.currentState = this.stateMap[state];
                console.log(`–ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ —Å—Ç–∞–Ω—É: ${state}, –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π: ${this.previousState}`);
                this.currentState.enter();
            }

            gameLoop(timestamp) {
                const deltaTime = (timestamp - this.lastTime) / 1000;
                this.lastTime = timestamp;

                const inputs = this.inputSystem.getInputs();
                this.inputSystem.clear();

                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                if (this.currentState) {
                    this.currentState.update(deltaTime);
                    this.currentState.render();
                    this.currentState.handleInput(inputs);
                }

                if (this.debug) {
                    console.log(`State: ${this.currentState ? this.currentState.constructor.name : 'none'}, Score: ${score}, Running: ${isGameRunning}, AR: ${arStarted}`);
                }

                requestAnimationFrame((ts) => this.gameLoop(ts));
            }
        }

        let gameInstance = null;

        function initCanvasGame() {
            console.log("‚ñ∂Ô∏è –ü–æ—á–∞—Ç–æ–∫ Canvas-–≥—Ä–∏!");
            isGameRunning = true;
            gameInstance = gameInstance || new Game();
            gameInstance.resetUI();
            gameInstance.showUI(['endBtn']);
            scoreText.style.display = 'block';
            scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
            document.getElementById('canvasGameContainer').style.display = 'block';
            document.querySelector('a-scene').style.display = 'none';
            if (doveVideoEntity) doveVideoEntity.setAttribute('visible', 'false');
            if (bgMusic && !bgMusic.muted) {
                bgMusic.play().catch(e => console.log("üîá –ú—É–∑–∏–∫–∞ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª–∞—Å—è:", e));
            }
        }

        function stopGame() {
            if (!isGameRunning) return;
            isGameRunning = false;
            arStarted = false;
            if (gameInstance) {
                gameInstance.resetUI();
                gameInstance.setState(GAME_STATES.MENU);
            }
            playBtn.style.display = 'block';
            soundBtn.style.display = 'block';
            youtubeBtn.style.display = 'block';
            document.getElementById('canvasGameContainer').style.display = 'none';
            document.querySelector('a-scene').style.display = 'block';
            if (doveVideoEntity) doveVideoEntity.setAttribute('visible', 'true');
            loader.style.display = 'block';
            stopAllAudio();
        }

        function resetGame() {
            stopGame();
            score = 0;
            scoreText.textContent = `üåü –û—á–∫–∏: ${score}`;
            gameInstance = null;
        }

        playBtn.addEventListener('click', initCanvasGame);
        stopBtn.addEventListener('click', stopGame);
        resetBtn.addEventListener('click', resetGame);
        document.getElementById('endBtn').addEventListener('click', stopGame);
    </script>
</body>
</html>
