<!DOCTYPE html>
<html>
<head>
  <title>AR Planet App with Custom MindAR Marker</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <script>
    // Компонент для обробки жестів (обертання пальцем, pinch для зуму)
    AFRAME.registerComponent('gesture-handler', {
      init: function () {
        this.targetRotation = this.el.getAttribute('rotation') || {x: 0, y: 0, z: 0};
        this.initialScale = this.el.object3D.scale.x;
        this.previousTouchDistance = 0;
        this.isRotating = false;
        this.isPinching = false;
        this.startX = 0;
        this.startY = 0;

        document.addEventListener('touchstart', this.onTouchStart.bind(this));
        document.addEventListener('touchmove', this.onTouchMove.bind(this));
        document.addEventListener('touchend', this.onTouchEnd.bind(this));
      },
      onTouchStart: function (evt) {
        if (evt.touches.length === 1) {
          this.isRotating = true;
          this.startX = evt.touches[0].pageX;
          this.startY = evt.touches[0].pageY;
        } else if (evt.touches.length === 2) {
          this.isPinching = true;
          this.previousTouchDistance = Math.hypot(
            evt.touches[0].pageX - evt.touches[1].pageX,
            evt.touches[0].pageY - evt.touches[1].pageY
          );
          this.initialScale = this.el.object3D.scale.x;
        }
      },
      onTouchMove: function (evt) {
        evt.preventDefault();
        if (this.isRotating && evt.touches.length === 1) {
          const deltaX = evt.touches[0].pageX - this.startX;
          const deltaY = evt.touches[0].pageY - this.startY;
          this.targetRotation.y += deltaX * 0.5;
          this.targetRotation.x += deltaY * 0.5;
          this.el.setAttribute('rotation', `${this.targetRotation.x} ${this.targetRotation.y} 0`);
          this.startX = evt.touches[0].pageX;
          this.startY = evt.touches[0].pageY;
        } else if (this.isPinching && evt.touches.length === 2) {
          const currentTouchDistance = Math.hypot(
            evt.touches[0].pageX - evt.touches[1].pageX,
            evt.touches[0].pageY - evt.touches[1].pageY
          );
          const scaleFactor = currentTouchDistance / this.previousTouchDistance;
          const newScale = Math.max(0.5, Math.min(3, this.initialScale * scaleFactor));
          this.el.setAttribute('scale', `${newScale} ${newScale} ${newScale}`);
          this.previousTouchDistance = currentTouchDistance;
        }
      },
      onTouchEnd: function (evt) {
        if (evt.touches.length === 0) {
          this.isRotating = false;
          this.isPinching = false;
        }
      }
    });

    // Компонент для кліку на точку (показ alert з завданням)
    AFRAME.registerComponent('click-task', {
      schema: { task: { type: 'string' } },
      init: function () {
        this.el.addEventListener('click', () => {
          alert(this.data.task);
        });
      }
    });

    // Діагностика MindAR
    const startMindAR = () => {
      const startButton = document.querySelector('#start');
      startButton.style.display = 'none';
      const scene = document.querySelector('a-scene');
      scene.setAttribute('mindar-image', { imageTargetSrc: 'my-marker.mind', autoStart: true, maxTrack: 1 });
      scene.addEventListener('targetFound', () => {
        document.querySelector('#status').innerText = 'Маркер розпізнано! Планета з\'явилася.';
      });
      scene.addEventListener('targetLost', () => {
        document.querySelector('#status').innerText = 'Маркер втрачено. Наведи камеру знову.';
      });
      scene.addEventListener('arError', (event) => {
        document.querySelector('#status').innerText = 'Помилка AR: ' + event.detail.error;
        console.error('MindAR Error:', event.detail);
      });
      scene.addEventListener('arReady', () => {
        document.querySelector('#status').innerText = 'AR готовий. Наведи камеру на маркер.';
      });
    };
  </script>
</head>
<body>
  <div id="status" style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); padding: 5px; font-size: 18px; z-index: 100;">Наведи камеру на маркер...</div>
  <button id="start" onclick="startMindAR()" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100;">Запустити AR</button>

  <a-scene embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
    <a-camera id="camera" position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse; fuse: false" raycaster="objects: .clickable"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-sphere id="planet"
                position="0 0 0"
                radius="0.5"
                src="earth.jpg" <!-- Використовую локальний earth.jpg -->
                gesture-handler
                scale="1 1 1">
        <!-- Точки з номерами (збільшено масштаб і виправлено позиціонування) -->
        <a-text class="clickable"
                value="1"
                position="0 0.6 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                billboard
                click-task="task: Мир починається з тебе! Напиши 3 добрі вчинки, які можеш зробити сьогодні."></a-text>
        <a-text class="clickable"
                value="2"
                position="0.6 0 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                billboard
                click-task="task: Захисти планету! Назви 3 способи зменшити пластикові відходи."></a-text>
        <a-text class="clickable"
                value="3"
                position="0 -0.6 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                billboard
                click-task="task: Будь добрим! Поділися компліментом з другом."></a-text>
        <a-text class="clickable"
                value="4"
                position="-0.6 0 0"
                scale="0.3 0.3 0.3"
                rotation="0 0 0"
                billboard
                click-task="task: Навчайся! Що ти хочеш вивчити цього тижня?"></a-text>
      </a-sphere>
    </a-entity>
  </a-scene>
</body>
</html>
